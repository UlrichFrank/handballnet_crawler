name: Daily Update & Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  schedule:
    # 20:00 UTC (21:00 CET/22:00 CEST) - using cron with daylight saving time offset
    # GitHub Actions interprets cron in UTC, so we use 20:00 UTC as base
    # Note: DST is automatically handled by GitHub Actions
    - cron: '0 20 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # 1. Checkout CODE from main branch
      - name: Checkout code (main branch)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # 2. Checkout DATA from data branch into subdirectory
      - name: Checkout data (data branch)
        uses: actions/checkout@v4
        with:
          ref: data
          path: _data_branch
          sparse-checkout: frontend/public/data
          fetch-depth: 0

      # 3. Merge data from data branch into working directory
      - name: Merge data from data branch
        shell: bash
        run: |
          if [ -d "_data_branch/frontend/public/data" ]; then
            mkdir -p frontend/public/data
            cp -r _data_branch/frontend/public/data/* frontend/public/data/ || true
            echo "âœ… Previous game data loaded from data branch"
          else
            echo "â„¹ï¸  First run: no previous data"
          fi
          rm -rf _data_branch

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # Setup pnpm caching
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Install Python dependencies
      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # Install Node dependencies
      - name: Install Node dependencies
        run: pnpm install --force

      # Run Scraper
      - name: Run Scraper
        run: |
          echo "ðŸ“Š Starting scraper..."
          python scraper.py --config config.gh.json
          echo "âœ… Scraper completed"

      # Generate Graphics
      - name: Generate Graphics
        run: |
          echo "ðŸŽ¨ Generating graphics..."
          python generate_graphics_from_json.py --config config.gh.json
          echo "âœ… Graphics generated"

      # Generate Excel Report
      - name: Generate Excel Report
        run: |
          echo "ðŸ“‹ Generating Excel report..."
          python generate_excel_report.py --config config.gh.json
          echo "âœ… Excel report generated"

      # Commit new game data to data branch
      - name: Commit and push game data to data branch
        shell: bash
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Check if there are data changes
          if [ -z "$(git status --porcelain frontend/public/data/)" ]; then
            echo "âœ… No new game data to commit"
            exit 0
          fi
          
          echo "ðŸ“ Pushing data to data branch..."
          
          # Clone data branch into temp directory
          mkdir -p /tmp/data-push
          cd /tmp/data-push
          git clone --branch data --depth 1 https://github.com/${{ github.repository }}.git .
          
          # Copy new data from main working directory
          mkdir -p frontend/public
          cp -r $GITHUB_WORKSPACE/frontend/public/data/* frontend/public/data/ 2>/dev/null || mkdir -p frontend/public/data
          
          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add frontend/public/data/
          git commit -m "chore: Update game data from scraper [skip ci]"
          git push origin data
          
          echo "âœ… Game data committed and pushed to data branch"

      # Build Frontend
      - name: Build Frontend
        run: |
          echo "ðŸ”¨ Building frontend..."
          pnpm run build
          echo "âœ… Frontend built successfully"
          
          # Copy static assets from public folder (SVGs, icons, etc.)
          echo "ðŸ“¦ Copying static assets..."
          if [ -f "frontend/public/team-logo.svg" ]; then
            cp frontend/public/team-logo.svg frontend/dist/team-logo.svg
            echo "âœ… Copied team-logo.svg"
          fi
          if [ -f "frontend/public/vite.svg" ]; then
            cp frontend/public/vite.svg frontend/dist/vite.svg
            echo "âœ… Copied vite.svg"
          fi
          
          # Copy config to dist
          # Use config/config.gh.json for production since public/config.json is git-ignored
          if [ -f "config/config.gh.json" ]; then
            cp config/config.gh.json frontend/dist/config.json
            echo "âœ… Copied config/config.gh.json to dist/config.json"
          elif [ -f "frontend/public/config.json" ]; then
            cp frontend/public/config.json frontend/dist/config.json
            echo "âœ… Copied frontend/public/config.json to dist/config.json"
          else
            echo "âŒ No config file found to copy to dist!"
            # List available config files for debugging
            ls -la config/
            ls -la frontend/public/
          fi
          
          # Copy data directory
          if [ -d "frontend/public/data" ]; then
            cp -r frontend/public/data frontend/dist/data
            echo "âœ… Copied data directory to dist/"
          else
            echo "âŒ data directory not found in frontend/public!"
          fi
          
          # Verify
          echo "ðŸ“‚ Final dist structure:"
          ls -la frontend/dist/

      # Prepare deployment artifacts
      - name: Prepare deployment artifacts
        run: |
          mkdir -p deploy/handballnet_crawler
          
          # Copy everything from frontend/dist
          if [ -d "frontend/dist" ]; then
            cp -r frontend/dist/* deploy/handballnet_crawler/
            echo "âœ… Copied frontend dist"
          else
            echo "âŒ frontend/dist directory not found!"
          fi
          
          # Copy output (Excel, graphics)
          if [ -d "output" ]; then
            cp -r output deploy/handballnet_crawler/output || echo "âŒ Failed to copy output"
            echo "âœ… Copied output files"
          fi
          
          echo "ðŸ“¦ Deployment directory ready"
          ls -la deploy/handballnet_crawler/
          echo "---"
          ls -la deploy/handballnet_crawler/data/ 2>/dev/null || echo "No data folder"

      # Deploy to GitHub Pages using GitHub Actions
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy/handballnet_crawler'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Workflow summary
      - name: Workflow Summary
        if: always()
        run: |
          echo "## âœ… Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed to:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Pages](https://ulrichfrank.github.io/handballnet_crawler/)" >> $GITHUB_STEP_SUMMARY
# Trigger rebuild
