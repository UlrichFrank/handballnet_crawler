name: Daily Update & Deploy to GitHub Pages

on:
  schedule:
    # 20:00 UTC (21:00 CET/22:00 CEST) - using cron with daylight saving time offset
    # GitHub Actions interprets cron in UTC, so we use 20:00 UTC as base
    # Note: DST is automatically handled by GitHub Actions
    - cron: '0 20 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout CODE from main branch
      - name: Checkout code (main branch)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # 2. Checkout DATA from data branch into subdirectory
      - name: Checkout data (data branch)
        uses: actions/checkout@v4
        with:
          ref: data
          path: _data_branch
          sparse-checkout: frontend/public/data
          fetch-depth: 0

      # 3. Merge data from data branch into working directory
      - name: Merge data from data branch
        shell: bash
        run: |
          if [ -d "_data_branch/frontend/public/data" ]; then
            mkdir -p frontend/public/data
            cp -r _data_branch/frontend/public/data/* frontend/public/data/ || true
            echo "âœ… Previous game data loaded from data branch"
          else
            echo "â„¹ï¸  First run: no previous data"
          fi
          rm -rf _data_branch

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # Setup pnpm caching
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Install Python dependencies
      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # Install Node dependencies
      - name: Install Node dependencies
        run: pnpm install --force

      # Run Scraper
      - name: Run Scraper
        run: |
          echo "ðŸ“Š Starting scraper..."
          python scraper.py --config config.gh.json
          echo "âœ… Scraper completed"

      # Generate Graphics
      - name: Generate Graphics
        run: |
          echo "ðŸŽ¨ Generating graphics..."
          python generate_graphics_from_json.py --config config.gh.json
          echo "âœ… Graphics generated"

      # Generate Excel Report
      - name: Generate Excel Report
        run: |
          echo "ðŸ“‹ Generating Excel report..."
          python generate_excel_report.py --config config.gh.json
          echo "âœ… Excel report generated"

      # Commit new game data to data branch
      - name: Commit and push game data to data branch
        shell: bash
        run: |
          git config user.name "UlrichFrank"
          git config user.email "Ulrich.Frank@web.de"
          
          # Check if there are data changes
          DATA_STATUS=$(git status --porcelain frontend/public/data/ 2>/dev/null | wc -l)
          
          if [ "$DATA_STATUS" -eq 0 ]; then
            echo "âœ… No new game data to commit"
            exit 0
          fi
          
          # Create a temporary branch to hold data changes
          git checkout -b temp-data-branch
          git add frontend/public/data/
          git commit -m "chore: Update game data from scraper [skip ci]" || echo "Nothing to commit"
          
          # Push to data branch using git push with refspec
          git push origin temp-data-branch:data || echo "Failed to push (may have conflicts)"
          
          # Delete temporary branch and go back to main
          git checkout main
          git branch -D temp-data-branch 2>/dev/null || true
          
          # Reset working directory to clean state
          git reset --hard HEAD
          git clean -fd
          
          # Re-fetch and restore data from data branch so it's available for build and deployment
          git fetch origin data:data-latest
          if [ -d ".git/refs/remotes/origin/data" ]; then
            mkdir -p frontend/public/data
            git checkout data-latest -- frontend/public/data/ 2>/dev/null || true
            echo "âœ… Data restored from data branch for deployment"
          fi

      # Build Frontend
      - name: Build Frontend
        run: |
          echo "ðŸ”¨ Building frontend..."
          pnpm run build
          echo "âœ… Frontend built successfully"

      # Prepare deployment artifacts
      - name: Prepare deployment artifacts
        run: |
          mkdir -p deploy/handballnet_crawler
          
          # Copy frontend dist to handballnet_crawler subdirectory
          if [ -d "frontend/dist" ]; then
            cp -r frontend/dist/* deploy/handballnet_crawler/
            echo "âœ… Copied frontend dist to handballnet_crawler/"
          fi
          
          # Copy config and data
          cp config.json deploy/handballnet_crawler/ 2>/dev/null || true
          if [ -d "frontend/public/data/data" ]; then
            cp -r frontend/public/data/data deploy/handballnet_crawler/data 2>/dev/null || true
          fi
          echo "âœ… Copied config and data"
          
          # Copy output (Excel, graphics)
          if [ -d "output" ]; then
            cp -r output deploy/handballnet_crawler/output 2>/dev/null || true
            echo "âœ… Copied output files"
          fi
          
          echo "ðŸ“¦ Deployment directory ready"
          tree deploy/ || ls -laR deploy/

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          cname: false
          force_orphan: false

      # Workflow summary
      - name: Workflow Summary
        if: always()
        run: |
          echo "## âœ… Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed to:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Pages](https://ulrichfrank.github.io/handballnet_crawler/)" >> $GITHUB_STEP_SUMMARY
