name: Daily Update & Deploy to GitHub Pages

on:
  schedule:
    # 20:00 UTC (21:00 CET/22:00 CEST) - using cron with daylight saving time offset
    # GitHub Actions interprets cron in UTC, so we use 20:00 UTC as base
    # Note: DST is automatically handled by GitHub Actions
    - cron: '0 20 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # Setup pnpm caching
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Install Python dependencies
      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # Install Node dependencies
      - name: Install Node dependencies
        run: pnpm install

      # Run Scraper
      - name: Run Scraper
        run: |
          echo "ðŸ“Š Starting scraper..."
          python scraper.py
          echo "âœ… Scraper completed"

      # Generate Graphics
      - name: Generate Graphics
        run: |
          echo "ðŸŽ¨ Generating graphics..."
          python generate_graphics_from_json.py
          echo "âœ… Graphics generated"

      # Generate Excel Report
      - name: Generate Excel Report
        run: |
          echo "ðŸ“‹ Generating Excel report..."
          python generate_excel_report.py
          echo "âœ… Excel report generated"

      # Build Frontend
      - name: Build Frontend
        run: |
          echo "ðŸ”¨ Building frontend..."
          npm run build
          echo "âœ… Frontend built successfully"

      # Prepare deployment artifacts
      - name: Prepare deployment artifacts
        run: |
          mkdir -p deploy
          
          # Copy frontend dist
          if [ -d "frontend/dist" ]; then
            cp -r frontend/dist/* deploy/
            echo "âœ… Copied frontend dist"
          fi
          
          # Copy config and data
          cp config.json deploy/ 2>/dev/null || true
          cp -r frontend/public/data deploy/data 2>/dev/null || true
          echo "âœ… Copied config and data"
          
          # Copy output (Excel, graphics)
          if [ -d "output" ]; then
            cp -r output deploy/output 2>/dev/null || true
            echo "âœ… Copied output files"
          fi
          
          echo "ðŸ“¦ Deployment directory ready"
          ls -la deploy/

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          cname: false
          force_orphan: false

      # Workflow summary
      - name: Workflow Summary
        if: always()
        run: |
          echo "## âœ… Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed to:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Pages](https://ulrichfrank.github.io/handballnet_crawler/)" >> $GITHUB_STEP_SUMMARY
